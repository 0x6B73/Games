<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"
/>
<title>Nozruc‚Äôs Neon Jackpots</title>
<meta name="theme-color" content="#00e5ff" />
<style>
  /* =========================
     Mobile-first UI theme
     ========================= */
  :root{
    --neon1:#00e5ff; --neon2:#ff2fd3; --neon3:#89ff00; --neon4:#ffb300;
    --text:#e7f8ff;  --muted:#9ed1df;
    --bg-grad: radial-gradient(1200px 900px at 50% 10%, #001018 0%, #02040a 45%, #000 80%);
    --pad: clamp(10px, 3vw, 18px);
    --gap: clamp(8px, 2.4vw, 16px);
    --radius: 16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    font-size:16px; /* avoid iOS zoom */
    background: var(--bg-grad);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    -webkit-tap-highlight-color: transparent;
    padding: env(safe-area-inset-top) env(safe-area-inset-right)
             env(safe-area-inset-bottom) env(safe-area-inset-left);
  }
  .app{min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto; gap:var(--gap)}
  .container{max-width:1000px; margin:0 auto; width:100%}

  /* Header */
  .hdr{padding:var(--pad) var(--pad) 6px; text-align:center}
  .logo{
    margin:0;
    font-weight:900; letter-spacing:.6px; line-height:1.1;
    font-size: clamp(26px, 7vw, 56px);
    background: linear-gradient(90deg,var(--neon1),var(--neon2),var(--neon4));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow: 0 0 22px rgba(0,229,255,.35);
  }
  .marquee{
    height:7px; max-width:min(680px,92%); margin:10px auto 0;
    border-radius:999px; position:relative; overflow:hidden;
    background:linear-gradient(90deg,#012,#024 30%,#013 60%,#012);
  }
  .marquee::before{
    content:""; position:absolute; inset:-50% auto auto -30%;
    width:60%; height:220%;
    background: conic-gradient(from 0deg, var(--neon2), var(--neon1), var(--neon3), var(--neon4), var(--neon2));
    filter: blur(12px) saturate(160%); opacity:.9; animation:sweep 3.5s linear infinite;
    pointer-events:none;
  }
  @keyframes sweep{to{transform: translateX(250%)}}

  /* Stage (game area) */
  .stage{
    position:relative; isolation:isolate;
    margin:0 auto; padding:var(--pad);
    max-width:900px;
    background: linear-gradient(180deg, rgba(0,229,255,.06), rgba(255,47,211,.05));
    border:1px solid rgba(0,229,255,.25);
    border-radius: var(--radius);
    box-shadow: 0 10px 30px rgba(0,0,0,.55);
  }
  .topbar{
    display:grid; grid-template-columns: repeat(3,1fr); gap:var(--gap);
    padding:8px; border-radius:12px;
    background:linear-gradient(180deg,rgba(0,229,255,.08),rgba(255,47,211,.06));
    border:1px solid rgba(0,229,255,.2);
  }
  .chip{
    display:flex; align-items:center; justify-content:center; gap:8px;
    min-height:44px; padding:10px; border-radius:999px;
    background:rgba(0,229,255,.08); border:1px solid rgba(0,229,255,.25);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:800;
    box-shadow: inset 0 0 10px rgba(0,229,255,.2);
  }
  .chip .dot{
    width:10px; height:10px; border-radius:999px; background:var(--neon1);
    box-shadow:0 0 10px var(--neon1), 0 0 20px var(--neon1);
  }

  /* Reels */
  .reels{
    display:grid; grid-template-columns: repeat(3,1fr); gap:var(--gap);
    margin:var(--gap) auto; max-width:760px;
  }
  .reel{
    position:relative; height: clamp(120px, 32vw, 210px); border-radius:14px;
    background: radial-gradient(260px 110px at 50% -20%, rgba(255,179,0,.2), rgba(255,47,211,.08)),
               linear-gradient(180deg,#0b1c28,#06141d 40%,#0b1c28);
    border:1px solid rgba(0,229,255,.25);
    box-shadow: inset 0 -30px 60px rgba(0,0,0,.45), 0 6px 18px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .window{
    position:absolute; inset:10px; border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,rgba(0,0,0,.4),rgba(0,0,0,.65));
    border:1px solid rgba(255,255,255,.06);
    font-size: clamp(44px, 12vw, 80px);
    text-shadow:0 0 14px rgba(255,255,255,.3);
  }
  .flash{animation:flash .7s ease-out}
  @keyframes flash{30%{box-shadow:0 0 22px 6px rgba(255,255,255,.38)}}

  /* Particle canvas overlays stage */
  #fx{
    position:absolute; inset:0; pointer-events:none; border-radius:inherit; overflow:hidden;
  }

  /* Message */
  .message{min-height:28px; text-align:center; margin:6px 0 2px; font-weight:900; color:#bfefff}

  /* Controls - sticky on mobile */
  .controls-wrap{
    position:sticky; bottom:0; z-index:15;
    padding: calc(8px + env(safe-area-inset-bottom)) var(--pad) var(--pad);
    background: linear-gradient(180deg, transparent, rgba(0,0,0,.55) 35%, rgba(0,0,0,.85));
    backdrop-filter: blur(6px);
  }
  .controls{
    display:grid; grid-template-columns: repeat(6,1fr); gap:var(--gap); max-width:900px; margin:0 auto;
  }
  button{
    appearance:none; -webkit-appearance:none;
    padding:14px; min-height:48px;
    border-radius:12px; border:1px solid rgba(0,229,255,.35);
    background:linear-gradient(180deg,rgba(0,229,255,.1),rgba(255,47,211,.06));
    color:var(--text); font-weight:900; letter-spacing:.35px; cursor:pointer;
    box-shadow:0 8px 18px rgba(0,0,0,.35), inset 0 0 16px rgba(0,229,255,.15);
  }
  button:active{transform:translateY(1px)}
  .primary{border-color:rgba(137,255,0,.45)}
  .input{
    width:100%; padding:12px; min-height:48px; border-radius:10px;
    border:1px solid rgba(0,229,255,.35); background:#07121a; color:var(--text);
    font-weight:900; text-align:center; font-size:16px;
  }
  #betInput{grid-column: span 2}
  #spinBtn{grid-column: span 4}
  #maxBtn,#bonusBtn,#oddsBtn{grid-column: span 2}

  /* Odds sheet (bottom modal) */
  .sheet{
    position:fixed; inset:auto 0 0 0; z-index:9999;
    background:#0a1118; color:var(--text);
    border-top-left-radius:18px; border-top-right-radius:18px;
    border:1px solid rgba(0,229,255,.25);
    transform:translateY(110%); transition:transform .28s ease;
    max-height:82dvh; overflow:auto; padding:16px;
  }
  .sheet.open{transform:translateY(0)}
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    background:rgba(0,229,255,.08); border:1px solid rgba(0,229,255,.25);
    font-weight:800; margin-right:8px; margin-bottom:8px;
  }
  .warn{color:#ff6b6b; font-weight:900}

  /* Narrow phones: stack top chips, compact grid */
  @media (max-width: 720px){
    .topbar{grid-template-columns:1fr}
    .controls{grid-template-columns: repeat(4,1fr)}
    #betInput{grid-column: span 2}
    #spinBtn{grid-column: span 2}
    #maxBtn,#bonusBtn,#oddsBtn{grid-column: span 4}
  }
  @media (max-width: 360px){
    .controls{grid-template-columns: repeat(3,1fr)}
    #betInput,#spinBtn{grid-column: span 3}
  }
</style>
</head>
<body>
  <div class="app">
    <header class="hdr container">
      <h1 class="logo">Nozruc‚Äôs Neon Jackpots</h1>
      <div class="marquee" aria-hidden="true"></div>
    </header>

    <main class="container">
      <section class="stage" id="stage" aria-label="Slot machine">
        <!-- Particle FX -->
        <canvas id="fx"></canvas>

        <!-- Score chips -->
        <div class="topbar">
          <div class="chip"><span class="dot"></span> Credits: <strong id="credits">0</strong></div>
          <div class="chip"><span class="dot" style="background:var(--neon2)"></span> High: <strong id="high">0</strong></div>
          <div class="chip"><span class="dot" style="background:var(--neon4)"></span> Spins: <strong id="spins">0</strong></div>
        </div>

        <!-- Reels -->
        <div class="reels">
          <div class="reel"><div class="window" id="r0">üçí</div></div>
          <div class="reel"><div class="window" id="r1">üçã</div></div>
          <div class="reel"><div class="window" id="r2">üîî</div></div>
        </div>

        <div class="message" id="message" role="status" aria-live="polite"></div>
      </section>
    </main>

    <!-- Sticky controls -->
    <nav class="controls-wrap">
      <div class="controls container">
        <button id="betDown" aria-label="Decrease bet">‚àí</button>
        <input id="betInput" class="input" type="number" min="1" max="100000" step="1" inputmode="numeric" pattern="[0-9]*" value="10" />
        <button id="betUp" aria-label="Increase bet">Ôºã</button>
        <button id="spinBtn" class="primary">SPIN ‚ú®</button>
        <button id="maxBtn" title="Bet maximum">Max</button>
        <button id="bonusBtn" title="Periodic bonus">Bonus</button>
        <button id="oddsBtn" title="Odds & Settings">Odds</button>
      </div>
    </nav>
  </div>

  <!-- Odds & Settings Bottom Sheet -->
  <aside id="sheet" class="sheet" role="dialog" aria-label="Odds & Settings">
    <h3 style="margin:0 0 8px">Odds & Settings</h3>
    <p style="margin:6px 0 12px; color:#cfe">
      Base house edge <strong>55%</strong>. Adjust within <strong>¬±25%</strong>.
    </p>
    <div style="display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
      <div>
        <label for="edgeSlider" style="font-weight:900; display:block; margin-bottom:6px">House Edge Adjustment</label>
        <input id="edgeSlider" type="range" min="-25" max="25" step="0.5" />
      </div>
      <div>
        <span class="badge">Base Edge: <span id="baseEdgeLabel">55%</span></span>
        <span class="badge">Adjustment: <span id="edgeAdjLabel">0%</span></span>
        <span class="badge">Current Edge: <span id="edgeLabel">55%</span></span>
        <span class="badge">Est. RTP: <span id="rtpLabel">45%</span></span>
      </div>
      <div>
        <button id="edgeReset" style="width:100%">Reset Adjustment</button>
      </div>
      <div>
        <button id="resetBtn" style="width:100%; border-color:#ff8080">Reset Progress</button>
      </div>
      <div>
        <button id="closeSheet" style="width:100%">Close</button>
      </div>
    </div>
    <p style="margin:12px 0 0; color:#cfe">Small payouts below your bet are <span class="warn">losses disguised as wins</span>. The show is loud on purpose.</p>
  </aside>

<script>
(() => {
  'use strict';

  /* ===============================
     Storage (guarded) & State
     =============================== */
  const SAVE_KEY = 'NOZRUC_V9_MOBILE';
  const storage = (() => {
    try { localStorage.setItem('_t','1'); localStorage.removeItem('_t'); return localStorage; }
    catch { return { getItem:()=>null, setItem:()=>{}, removeItem:()=>{} }; }
  })();
  const now = () => Date.now();
  const BASE_EDGE = 55;  // %
  const SLIDER_RANGE = 25;

  const defaultState = () => ({
    credits: 500,
    bet: 10,
    spins: 0,
    high: 500,
    lastBonus: 0,
    edgeAdj: 0,   // ¬±25
  });

  let state = load();
  function load(){
    try{
      const raw = storage.getItem(SAVE_KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      if(!Number.isFinite(s.credits)||s.credits<0) s.credits=500;
      if(!Number.isFinite(s.bet)||s.bet<1) s.bet=10;
      if(!Number.isFinite(s.spins)||s.spins<0) s.spins=0;
      if(!Number.isFinite(s.high)||s.high<0) s.high=500;
      if(!Number.isFinite(s.lastBonus)||s.lastBonus<0) s.lastBonus=0;
      if(!Number.isFinite(s.edgeAdj)) s.edgeAdj=0;
      return s;
    }catch{ return defaultState(); }
  }
  function save(){ storage.setItem(SAVE_KEY, JSON.stringify(state)); }

  /* ===============================
     Elements
     =============================== */
  const $ = id => document.getElementById(id);
  const creditsEl = $('credits'), highEl = $('high'), spinsEl = $('spins');
  const r0 = $('r0'), r1 = $('r1'), r2 = $('r2');
  const msgEl = $('message'), stage = $('stage');
  const spinBtn = $('spinBtn'), betUpBtn = $('betUp'), betDownBtn = $('betDown');
  const maxBtn = $('maxBtn'), bonusBtn = $('bonusBtn'), betInput = $('betInput');
  const oddsBtn = $('oddsBtn'), sheet = $('sheet'), closeSheet = $('closeSheet');
  const edgeSlider = $('edgeSlider'), edgeReset = $('edgeReset');
  const baseEdgeLabel = $('baseEdgeLabel'), edgeAdjLabel = $('edgeAdjLabel'),
        rtpLabel = $('rtpLabel'), edgeLabel = $('edgeLabel');
  const fxCanvas = $('fx'), fxc = fxCanvas.getContext('2d');

  /* ===============================
     Audio (WebAudio, OTT casino)
     =============================== */
  const AudioKit = (() => {
    const Ctx = window.AudioContext || window.webkitAudioContext;
    const ctx = new Ctx();
    let unlocked = false;
    const unlock = () => {
      if (!unlocked) { ctx.resume(); unlocked = true; }
    };
    // unlock on first user gesture
    ['pointerdown','touchstart','click'].forEach(t =>
      window.addEventListener(t, unlock, { once:true })
    );

    const master = ctx.createGain(); master.gain.value = 0.22; master.connect(ctx.destination);
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value=-22; comp.knee.value=20; comp.ratio.value=8; comp.attack.value=0.003; comp.release.value=0.25;
    comp.connect(master);
    const delay = ctx.createDelay(0.6); delay.delayTime.value = 0.14;
    const dGain = ctx.createGain(); dGain.gain.value = 0.18; delay.connect(dGain); dGain.connect(comp);

    const chain = n => { n.connect(comp); n.connect(delay); };

    function osc({type='square', f0=440, f1=440, dur=0.15, gain=0.8, start=0}){
      const o = ctx.createOscillator(); o.type = type;
      const t0 = ctx.currentTime + start;
      o.frequency.setValueAtTime(f0, t0);
      if(f1!==f0) o.frequency.exponentialRampToValueAtTime(Math.max(40,f1), t0+dur);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(gain, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
      o.connect(g); chain(g); o.start(t0); o.stop(t0+dur+0.02);
    }
    function noise({dur=0.2, lp=12000, hp=200, gain=0.5, start=0}){
      const bufferSize = Math.max(1, Math.floor(ctx.sampleRate*dur));
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<bufferSize;i++) data[i]=(Math.random()*2-1);
      const src=ctx.createBufferSource(); src.buffer=buffer;
      const g=ctx.createGain(); g.gain.value=gain;
      const lpf=ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=lp;
      const hpf=ctx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=hp;
      src.connect(hpf); hpf.connect(lpf); lpf.connect(g); chain(g);
      const t0 = ctx.currentTime + start;
      src.start(t0); src.stop(t0+dur);
    }

    // SFX palette
    const lever = () => { noise({dur:.09, lp:8000, hp:1000, gain:.35}); osc({type:'triangle', f0:220, f1:160, dur:.10, gain:.7}); };
    const spinWhoosh = () => { for(let i=0;i<11;i++) osc({type:'sawtooth', f0:220+i*36, f1:260+i*44, dur:.06, gain:.35, start:i*0.045}); };
    const tick = () => { osc({type:'square', f0:1200, f1:1000, dur:.03, gain:.36}); };
    const stopClack = () => { noise({dur:.05, lp:5000, hp:1200, gain:.33}); osc({type:'square', f0:300, f1:240, dur:.05, gain:.28}); };
    const smallWin = () => { [660,880].forEach((f,i)=>osc({type:'triangle',f0:f,f1:f*1.02,dur:.16,gain:.58,start:i*.09})); };
    const win = () => { [523,659,783,1046].forEach((f,i)=>osc({type:'triangle',f0:f,f1:f*1.015,dur:.18,gain:.65,start:i*.1})); };
    const mega = () => { for(let i=0;i<12;i++) osc({type:'sawtooth', f0:300+i*45, f1:420+i*60, dur:.09, gain:.6, start:i*.06}); };
    const lose = () => { [220,196].forEach((f,i)=>osc({type:'sine', f0:f, f1:f*.98, dur:.2, gain:.42, start:i*.08})); };

    return { lever, spinWhoosh, tick, stopClack, smallWin, win, mega, lose };
  })();

  /* ===============================
     Particles (win blasts)
     =============================== */
  let particles = [];
  function resizeFX(){
    const rect = stage.getBoundingClientRect();
    fxCanvas.width = rect.width * window.devicePixelRatio;
    fxCanvas.height = rect.height * window.devicePixelRatio;
    fxCanvas.style.width = rect.width + 'px';
    fxCanvas.style.height = rect.height + 'px';
    fxc.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
  }
  const rand=(a,b)=>a+Math.random()*(b-a);
  function spawnWinFX(mult, strength){
    // mult ~ payout / bet; strength ~ scaled 0..1
    const rect = stage.getBoundingClientRect();
    const cx = rect.width/2, cy = rect.height*0.36;
    const count = Math.round(30 + strength*120);
    for(let i=0;i<count;i++){
      const huePick = Math.random();
      const color = huePick<.33? 'rgba(0,229,255,' : (huePick<.66? 'rgba(255,47,211,' : 'rgba(137,255,0,');
      particles.push({
        x: cx, y: cy,
        vx: rand(-2-strength*2, 2+strength*2),
        vy: rand(-3-strength*3, -1-strength*1),
        life: rand(0.7, 1.5) + strength*0.6,
        age: 0,
        size: rand(2, 4) + strength*2,
        colorBase: color
      });
    }
  }
  function stepFX(dt){
    fxc.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    particles = particles.filter(p => p.age < p.life);
    for(const p of particles){
      p.age += dt;
      p.vy += 4 * dt; // gravity
      p.x += p.vx;
      p.y += p.vy;
      const t = Math.min(1, p.age / p.life);
      const alpha = (1 - t) * 0.9;
      fxc.fillStyle = p.colorBase + alpha + ')';
      fxc.beginPath(); fxc.arc(p.x, p.y, p.size*(1+.4*(1-t)), 0, Math.PI*2); fxc.fill();
    }
    requestAnimationFrame(loopFX);
  }
  let lastTS = performance.now();
  function loopFX(ts){
    const dt = Math.max(0.001, Math.min(0.033, (ts - lastTS)/1000));
    lastTS = ts;
    stepFX(dt);
  }
  const ro = new ResizeObserver(resizeFX); ro.observe(stage);
  resizeFX(); requestAnimationFrame(loopFX);

  /* ===============================
     Symbols, odds, LDW-bias
     =============================== */
  const symbols = [
    {ch:'üçí', weight:22, pay:4},
    {ch:'üçã', weight:22, pay:3},
    {ch:'üîî', weight:16, pay:6},
    {ch:'‚≠ê', weight:12, pay:10},
    {ch:'üíé', weight:7,  pay:20},
    {ch:'7Ô∏è‚É£', weight:4,  pay:50},
    {ch:'üåà', weight:8,  pay:0, wild:true}
  ];
  const weighted = []; for(const s of symbols) for(let i=0;i<s.weight;i++) weighted.push(s);
  const randSym = ()=> weighted[(Math.random()*weighted.length)|0];

  function evaluate(a,b,c){
    const arr=[a,b,c]; const wilds=arr.filter(s=>s.wild).length; const bases=arr.filter(s=>!s.wild);
    const counts={}; for(const s of bases) counts[s.ch]=(counts[s.ch]||0)+1;
    if(bases.length===3 && bases[0].ch===bases[1].ch && bases[1].ch===bases[2].ch) return {mult:bases[0].pay, tag:'3kind'};
    if(wilds>=1 && bases.length>=2){
      const same=Object.keys(counts).find(k=>counts[k]>=2);
      if(same){ const sym=bases.find(x=>x.ch===same); return {mult:sym.pay, tag:'3kind-wild'}; }
    }
    if(Object.values(counts).some(n=>n===2) || (wilds>=1 && bases.length>=1)) return {mult:0.6, tag:'2kind'};
    if(arr.some(s=>['‚≠ê','üíé','7Ô∏è‚É£'].includes(s.ch))) return {mult:0.2, tag:'single-high'};
    return {mult:0, tag:'lose'};
  }

  // Compute base RTP (expected multiplier per spin before scaling)
  function computeBaseRTP(){
    const tw = weighted.length;
    let E=0;
    for(let i=0;i<tw;i++){
      const si = weighted[i];
      for(let j=0;j<tw;j++){
        const sj = weighted[j];
        for(let k=0;k<tw;k++){
          const sk = weighted[k];
          const {mult} = evaluate(si,sj,sk);
          E += mult;
        }
      }
    }
    return E / (tw*tw*tw);
  }
  const BASE_RTP = computeBaseRTP();
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const targetEdge = ()=> clamp(BASE_EDGE + (Number(state.edgeAdj)||0), 0, 95);
  const targetRTP  = ()=> 1 - targetEdge()/100;
  const scaleMultiplier = ()=> clamp(targetRTP()/BASE_RTP, 0.05, 2);

  /* ===============================
     UI helpers
     =============================== */
  const fmt = n => n.toLocaleString();
  function setMessage(t){ msgEl.innerHTML = t || ''; }
  function flash(el){ el.classList.remove('flash'); void el.offsetWidth; el.classList.add('flash'); }

  function sync(){
    creditsEl.textContent = fmt(state.credits);
    highEl.textContent = fmt(state.high);
    spinsEl.textContent = fmt(state.spins);
    betInput.value = state.bet;
    edgeSlider.value = state.edgeAdj;
    baseEdgeLabel.textContent = `${BASE_EDGE}%`;
    edgeAdjLabel.textContent = `${(+state.edgeAdj).toFixed(1)}%`;
    edgeLabel.textContent = `${(targetEdge()).toFixed(1)}%`;
    rtpLabel.textContent = `${(targetRTP()*100).toFixed(1)}%`;
  }
  sync();

  /* ===============================
     Betting & controls
     =============================== */
  function setBet(v){
    state.bet = clamp(Math.round(v)||1, 1, 100000);
    save(); sync();
  }
  betUpBtn.addEventListener('click', ()=>{ AudioKit.tick(); setBet(state.bet + 5); });
  betDownBtn.addEventListener('click', ()=>{ AudioKit.tick(); setBet(state.bet - 5); });
  maxBtn.addEventListener('click', ()=>{ AudioKit.tick(); setBet(Math.min(state.credits, 100000)); });
  betInput.addEventListener('change', ()=> setBet(betInput.value));
  betInput.addEventListener('focus', e=> e.target.select());

  // Bonus every 2 minutes
  function tryBonus(){
    const COOLDOWN=120000, amt=50; const ready = now() - state.lastBonus >= COOLDOWN;
    if(ready){ state.credits += amt; state.lastBonus = now(); setMessage(`Bonus +${amt} credits! ‚ú®`); flash(stage); save(); sync(); return true; }
    const left = Math.ceil((COOLDOWN - (now()-state.lastBonus))/1000);
    setMessage(`Bonus ready in ${left}s‚Ä¶`); return false;
  }
  bonusBtn.addEventListener('click', ()=>{ AudioKit.tick(); tryBonus(); });

  // Odds sheet
  oddsBtn.addEventListener('click', ()=>{ sheet.classList.add('open'); });
  closeSheet.addEventListener('click', ()=>{ sheet.classList.remove('open'); });
  edgeSlider.addEventListener('input', ()=>{
    state.edgeAdj = clamp(parseFloat(edgeSlider.value)||0, -SLIDER_RANGE, SLIDER_RANGE);
    save(); sync();
  });
  edgeReset.addEventListener('click', ()=>{ state.edgeAdj = 0; save(); sync(); });

  // Reset
  $('resetBtn').addEventListener('click', ()=>{
    if(confirm('Reset all progress? This cannot be undone.')){
      storage.removeItem(SAVE_KEY);
      state = defaultState(); save(); sync();
      r0.textContent='üçí'; r1.textContent='üçã'; r2.textContent='üîî';
      setMessage('Progress reset. Fresh bankroll!'); flash(stage);
    }
  });

  /* ===============================
     Spin logic
     =============================== */
  let spinning = false;
  let spinTimers = [];
  function clearTimers(){ spinTimers.forEach(id=>clearTimeout(id)); spinTimers.length=0; }

  function doSpin(){
    if(spinning) return;
    if(state.bet > state.credits){ setMessage('Not enough credits. Lower your bet or claim a bonus.'); AudioKit.lose(); return; }

    AudioKit.lever(); AudioKit.spinWhoosh();
    setMessage('Spinning‚Ä¶');
    spinning = true;
    state.credits -= state.bet; save(); sync();

    const reels = [r0,r1,r2];
    const stopDelays = [760, 1080, 1420];
    const roll = [null, null, null];

    const intervalIds = [];
    for(let i=0;i<3;i++){
      let speed = 90 - i*10;
      const id = setInterval(()=>{
        const s = randSym(); reels[i].textContent = s.ch;
        AudioKit.tick();
      }, Math.max(40, speed));
      intervalIds.push(id);
    }

    stopDelays.forEach((d,i)=>{
      const tid = setTimeout(()=>{
        clearInterval(intervalIds[i]);
        const s = randSym(); reels[i].textContent = s.ch; roll[i]=s; flash(reels[i]); AudioKit.stopClack();

        if(i===2){
          const {mult, tag} = evaluate(roll[0], roll[1], roll[2]);
          const scale = scaleMultiplier();
          const payout = Math.floor(state.bet * mult * scale);
          const net = payout - state.bet;

          if(mult>0 && payout>0){
            state.credits += payout;
            const strength = clamp((payout/state.bet - 0.2)/50, 0, 1); // normalize 0..1
            spawnWinFX(mult, strength);
            if(mult>=50) AudioKit.mega(); else if(mult>=10) AudioKit.win(); else AudioKit.smallWin();
            setMessage(`You won ${fmt(payout)} credits! üéâ`);
          } else {
            AudioKit.lose();
            setMessage('So close!');
          }

          state.spins++;
          if(state.credits>state.high) state.high = state.credits;

          save(); sync(); spinning=false; clearTimers();
        }
      }, d);
      spinTimers.push(tid);
    });
  }

  spinBtn.addEventListener('click', doSpin);
  document.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); doSpin(); } });

  /* ===============================
     Boot
     =============================== */
  (function boot(){
    if(state.credits<=0){ state.credits=100; setMessage('Here are 100 credits to keep playing!'); }
    sync();
    // small intro flash
    setTimeout(()=>flash(stage), 350);
  })();

})();
</script>
</body>
</html>
